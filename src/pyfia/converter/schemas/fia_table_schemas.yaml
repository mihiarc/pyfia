# FIA Database Table Schema Definitions
# This file defines the expected schema for FIA DataMart tables to handle
# mixed data types and ensure consistent conversion to DuckDB format.

version: "1.0"
description: "Schema definitions for USDA Forest Inventory Analysis (FIA) DataMart tables"

# Reference Tables
reference_tables:
  REF_SPECIES:
    description: "Species reference table with taxonomic information"
    columns:
      SPCD:
        type: "smallint"
        nullable: false
        description: "Species code"
      COMMON_NAME:
        type: "varchar(100)"
        nullable: true
        description: "Common name of species"
      SCIENTIFIC_NAME:
        type: "varchar(100)"
        nullable: true
        description: "Scientific name of species"
      GENUS:
        type: "varchar(50)"
        nullable: true
        description: "Genus name"
      SPECIES:
        type: "varchar(50)"
        nullable: true
        description: "Species name"
      VARIETY:
        type: "varchar(50)"
        nullable: true
      SUBSPECIES:
        type: "varchar(50)"
        nullable: true
      SPECIES_SYMBOL:
        type: "varchar(20)"
        nullable: true
      E_SPGRPCD:
        type: "tinyint"
        nullable: true
      W_SPGRPCD:
        type: "tinyint"
        nullable: true
      SPGRPCD:
        type: "tinyint"
        nullable: true
      WOOD_SPGR_GREENVOL_DRYWT:
        type: "decimal(6,4)"
        nullable: true
      WOOD_SPGR_MC12_DRYWT:
        type: "decimal(6,4)"
        nullable: true
      BARK_SPGR_MC12_DRYWT:
        type: "decimal(6,4)"
        nullable: true
      SFTWD_HRDWD:
        type: "varchar(2)"
        nullable: true
        description: "Softwood/hardwood indicator (S, H, or ?)"

  REF_FOREST_TYPE:
    description: "Forest type reference table"
    columns:
      FORTYPCD:
        type: "smallint"
        nullable: false
      FORTYPNM:
        type: "varchar(100)"
        nullable: true
      FORTYPGRPCD:
        type: "tinyint"
        nullable: true
      FORTYPGRPNM:
        type: "varchar(50)"
        nullable: true

  REF_HABITAT_TYPE:
    description: "Habitat type reference table"
    columns:
      HABTYPCD:
        type: "smallint"
        nullable: false
      HABTYPNM:
        type: "varchar(100)"
        nullable: true

# Population Tables  
population_tables:
  POP_EVAL:
    description: "Population evaluation definitions"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      EVALID:
        type: "integer"
        nullable: false
        description: "Evaluation identifier"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code"
      EVAL_GRP:
        type: "varchar(50)"
        nullable: true
      EVAL_TYP:
        type: "varchar(20)"
        nullable: true
      EVAL_DESCR:
        type: "varchar(200)"
        nullable: true
      START_INVYR:
        type: "smallint"
        nullable: true
      END_INVYR:
        type: "smallint"
        nullable: true
      RSLTINTY:
        type: "tinyint"
        nullable: true
      NOTES:
        type: "varchar(2000)"
        nullable: true

  POP_EVAL_TYP:
    description: "Population evaluation types"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      EVAL_TYP:
        type: "varchar(20)"
        nullable: false
      EVAL_TYP_DESCR:
        type: "varchar(200)"
        nullable: true

  POP_EVAL_GRP:
    description: "Population evaluation groups"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      EVAL_GRP:
        type: "varchar(50)"
        nullable: false
      EVAL_GRP_DESCR:
        type: "varchar(200)"
        nullable: true

  POP_ESTN_UNIT:
    description: "Population estimation units"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      EVAL_CN:
        type: "varchar(34)"
        nullable: false
        description: "Evaluation control number (stored as string for large values)"
      RSCD:
        type: "integer"
        nullable: false
        description: "Resource code"
      EVALID:
        type: "integer"
        nullable: false
      ESTN_UNIT:
        type: "integer"
        nullable: true
        description: "Estimation unit number"
      ESTN_UNIT_DESCR:
        type: "varchar(255)"
        nullable: true
        description: "Estimation unit description"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code (expanded for safety)"
      AREALAND_EU:
        type: "decimal(15,4)"
        nullable: true
        description: "Land area of estimation unit"
      AREATOT_EU:
        type: "decimal(15,4)"
        nullable: true
        description: "Total area of estimation unit"
      AREA_USED:
        type: "decimal(15,4)"
        nullable: true
        description: "Area used"
      AREA_SOURCE:
        type: "varchar(50)"
        nullable: true
        description: "Source of area data (can contain strings like 'NLCD 2011 CANOPY')"
      P1PNTCNT_EU:
        type: "integer"
        nullable: true
        description: "Phase 1 point count for estimation unit"
      P1SOURCE:
        type: "varchar(50)"
        nullable: true
        description: "Phase 1 source information"
      CREATED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Created date (mixed format, keep as varchar)"
      MODIFIED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Modified date (mixed format, keep as varchar)"

  POP_STRATUM:
    description: "Population strata definitions"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      ESTN_UNIT_CN:
        type: "varchar(34)"
        nullable: false
        description: "Estimation unit control number (stored as string for large values)"
      RSCD:
        type: "integer"
        nullable: false
        description: "Resource code"
      EVALID:
        type: "integer"
        nullable: false
      ESTN_UNIT:
        type: "integer"
        nullable: false
        description: "Estimation unit number"
      STRATUMCD:
        type: "integer"
        nullable: false
        description: "Stratum code"
      STRATUM_DESCR:
        type: "varchar(255)"
        nullable: false
        description: "Stratum description"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code (expanded for safety)"
      P1POINTCNT:
        type: "integer"
        nullable: true
        description: "Phase 1 point count"
      P2POINTCNT:
        type: "integer"
        nullable: true
        description: "Phase 2 point count"
      EXPNS:
        type: "decimal(12,4)"
        nullable: true
        description: "Expansion factor"
      ADJ_FACTOR_MACR:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor macroplot"
      ADJ_FACTOR_SUBP:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor subplot"
      ADJ_FACTOR_MICR:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor microplot"
      ADJ_FACTOR_CWD:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor coarse woody debris"
      ADJ_FACTOR_FWD_SM:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor fine woody debris small"
      ADJ_FACTOR_FWD_LG:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor fine woody debris large"
      ADJ_FACTOR_DUFF:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor duff"
      CREATED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Created date (mixed format, keep as varchar)"
      MODIFIED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Modified date (mixed format, keep as varchar)"
      ADJ_FACTOR_PILE:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor pile"
      ADJ_FACTOR_REGEN_MICR:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor regeneration microplot"
      ADJ_FACTOR_INV_SUBP:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor invasive subplot"
      ADJ_FACTOR_P2VEG_SUBP:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor P2 vegetation subplot"
      ADJ_FACTOR_GRNDLYR_MICROQUAD:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor ground layer microquadrat"
      ADJ_FACTOR_SOIL:
        type: "decimal(8,6)"
        nullable: true
        description: "Adjustment factor soil"

  POP_PLOT_STRATUM_ASSGN:
    description: "Plot stratum assignments"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      STRATUM_CN:
        type: "varchar(34)"
        nullable: false
        description: "Stratum control number (stored as string for large values)"
      PLT_CN:
        type: "varchar(34)"
        nullable: false
        description: "Plot control number (stored as string for large values)"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code"
      INVYR:
        type: "integer"
        nullable: false
        description: "Inventory year"
      UNITCD:
        type: "integer"
        nullable: false
        description: "Unit code"
      COUNTYCD:
        type: "integer"
        nullable: false
        description: "County code"
      PLOT:
        type: "integer"
        nullable: false
        description: "Plot number"
      RSCD:
        type: "integer"
        nullable: false
        description: "Resource code"
      EVALID:
        type: "integer"
        nullable: false
        description: "Evaluation ID"
      ESTN_UNIT:
        type: "integer"
        nullable: false
        description: "Estimation unit"
      STRATUMCD:
        type: "integer"
        nullable: false
        description: "Stratum code"
      CREATED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Created date (mixed format, keep as varchar)"
      MODIFIED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Modified date (mixed format, keep as varchar)"

# Measurement Tables
measurement_tables:
  PLOT:
    description: "Plot-level measurements"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      SRV_CN:
        type: "varchar(34)"
        nullable: false
        description: "Survey control number"
      CTY_CN:
        type: "varchar(34)"
        nullable: false
        description: "County control number"
      PREV_PLT_CN:
        type: "varchar(34)"
        nullable: true
        description: "Previous plot control number"
      INVYR:
        type: "integer"
        nullable: false
        description: "Inventory year"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code"
      UNITCD:
        type: "integer"
        nullable: false
        description: "Unit code"  
      COUNTYCD:
        type: "integer"
        nullable: false
        description: "County code"
      PLOT:
        type: "integer"
        nullable: false
        description: "Plot number"
      PLOT_STATUS_CD: 
        type: "integer"
        nullable: true
        description: "Plot status code"
      PLOT_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "Plot non-sample reason code"
      MEASYEAR:
        type: "integer"
        nullable: true
        description: "Measurement year"
      MEASMON:
        type: "integer"
        nullable: true
        description: "Measurement month"
      MEASDAY:
        type: "integer"
        nullable: true
        description: "Measurement day"
      REMPER:
        type: "decimal(8,4)"
        nullable: true
        description: "Remeasurement period"
      KINDCD:
        type: "integer"
        nullable: false
        description: "Kind code"
      DESIGNCD:
        type: "integer"
        nullable: true
        description: "Design code"
      RDDISTCD:
        type: "integer"
        nullable: true
        description: "Road distance code"
      WATERCD:
        type: "integer"
        nullable: true
        description: "Water code"
      LAT:
        type: "decimal(9,6)"
        nullable: true
        description: "Latitude"
      LON:
        type: "decimal(10,6)"
        nullable: true
        description: "Longitude"
      ELEV:
        type: "integer"
        nullable: true
        description: "Elevation"
      GROW_TYP_CD:
        type: "integer"
        nullable: true
        description: "Growth type code"
      MORT_TYP_CD:
        type: "integer"
        nullable: true
        description: "Mortality type code"
      P2PANEL:
        type: "integer"
        nullable: true
        description: "Phase 2 panel"
      P3PANEL:
        type: "integer"
        nullable: true
        description: "Phase 3 panel"
      MANUAL:
        type: "decimal(8,4)"
        nullable: false
        description: "Manual flag"
      KINDCD_NC:
        type: "integer"
        nullable: true
        description: "Kind code NC"
      QA_STATUS:
        type: "integer"
        nullable: true
        description: "Quality assurance status"
      CREATED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Created date"
      MODIFIED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Modified date"
      MICROPLOT_LOC:
        type: "varchar(12)"
        nullable: true
        description: "Microplot location"
      DECLINATION:
        type: "decimal(8,4)"
        nullable: true
        description: "Declination"
      SAMP_METHOD_CD:
        type: "integer"
        nullable: true
        description: "Sample method code"
      SUBP_EXAMINE_CD:
        type: "integer"
        nullable: false
        description: "Subplot examine code"
      MACRO_BREAKPOINT_DIA:
        type: "integer"
        nullable: true
        description: "Macro breakpoint diameter"
      INTENSITY:
        type: "varchar(3)"
        nullable: true
        description: "Intensity"
      CYCLE:
        type: "integer"
        nullable: true
        description: "Cycle"
      SUBCYCLE:
        type: "integer"
        nullable: true
        description: "Subcycle"
      TOPO_POSITION_PNW:
        type: "varchar(2)"
        nullable: true
        description: "Topographic position PNW"
      NF_SAMPLING_STATUS_CD:
        type: "integer"
        nullable: true
        description: "National forest sampling status code"
      NF_PLOT_STATUS_CD:
        type: "integer"
        nullable: true
        description: "National forest plot status code"
      NF_PLOT_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "National forest plot non-sample reason code"
      P2VEG_SAMPLING_STATUS_CD:
        type: "integer"
        nullable: true
        description: "Phase 2 vegetation sampling status code"
      P2VEG_SAMPLING_LEVEL_DETAIL_CD:
        type: "integer"
        nullable: true
        description: "Phase 2 vegetation sampling level detail code"
      INVASIVE_SAMPLING_STATUS_CD:
        type: "integer"
        nullable: true
        description: "Invasive sampling status code"
      INVASIVE_SPECIMEN_RULE_CD:
        type: "integer"
        nullable: true
        description: "Invasive specimen rule code"
      DESIGNCD_P2A:
        type: "integer"
        nullable: true
        description: "Design code P2A"
      MANUAL_DB:
        type: "decimal(8,4)"
        nullable: true
        description: "Manual database"
      SUBPANEL:
        type: "integer"
        nullable: true
        description: "Subpanel"
      FUTFORCD_RMRS:
        type: "integer"
        nullable: true
        description: "Future forest code RMRS"
      MANUAL_NCRS:
        type: "decimal(8,4)"
        nullable: true
        description: "Manual NCRS"
      MANUAL_NERS:
        type: "decimal(8,4)"
        nullable: true
        description: "Manual NERS"
      MANUAL_RMRS:
        type: "decimal(8,4)"
        nullable: true
        description: "Manual RMRS"
      PAC_ISLAND_PNWRS:
        type: "varchar(20)"
        nullable: true
        description: "Pacific island PNWRS"
      PLOT_SEASON_NERS:
        type: "integer"
        nullable: true
        description: "Plot season NERS"
      PREV_MICROPLOT_LOC_RMRS:
        type: "varchar(12)"
        nullable: true
        description: "Previous microplot location RMRS"
      PREV_PLOT_STATUS_CD_RMRS:
        type: "integer"
        nullable: true
        description: "Previous plot status code RMRS"
      REUSECD1:
        type: "integer"
        nullable: true
        description: "Reuse code 1"
      REUSECD2:
        type: "integer"
        nullable: true
        description: "Reuse code 2"
      REUSECD3:
        type: "integer"
        nullable: true
        description: "Reuse code 3"
      GRND_LYR_SAMPLING_STATUS_CD:
        type: "integer"
        nullable: true
        description: "Ground layer sampling status code"
      GRND_LYR_SAMPLING_METHOD_CD:
        type: "integer"
        nullable: true
        description: "Ground layer sampling method code"

  # COND table schema moved to separate file: cond_table_schema.yaml

  SUBPLOT:
    description: "Subplot-level measurements"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      PLT_CN:
        type: "varchar(34)"
        nullable: false
        description: "Plot control number (stored as string for large values)"
      PREV_SBP_CN:
        type: "varchar(34)"
        nullable: true
        description: "Previous subplot control number"
      INVYR:
        type: "integer"
        nullable: false
        description: "Inventory year"
      STATECD:
        type: "smallint"
        nullable: false
        description: "State code"
      UNITCD:
        type: "integer"
        nullable: false
        description: "Unit code"
      COUNTYCD:
        type: "integer"
        nullable: false
        description: "County code"
      PLOT:
        type: "integer"
        nullable: false
        description: "Plot number"
      SUBP:
        type: "integer"
        nullable: false
        description: "Subplot number"
      SUBP_STATUS_CD:
        type: "integer"
        nullable: true
        description: "Subplot status code"
      POINT_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "Point non-sample reason code"
      MICRCOND:
        type: "integer"
        nullable: true
        description: "Microplot condition"
      SUBPCOND:
        type: "integer"
        nullable: true
        description: "Subplot condition"
      MACRCOND:
        type: "integer"
        nullable: true
        description: "Macroplot condition"
      CONDLIST:
        type: "integer"
        nullable: true
        description: "Condition list"
      SLOPE:
        type: "integer"
        nullable: true
        description: "Slope"
      ASPECT:
        type: "integer"
        nullable: true
        description: "Aspect"
      WATERDEP:
        type: "decimal(8,4)"
        nullable: true
        description: "Water depth"
      P2A_GRM_FLG:
        type: "varchar(1)"
        nullable: true
        description: "P2A GRM flag"
      CREATED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Created date"
      MODIFIED_DATE:
        type: "varchar(30)"
        nullable: true
        description: "Modified date"
      CYCLE:
        type: "integer"
        nullable: true
        description: "Cycle"
      SUBCYCLE:
        type: "integer"
        nullable: true
        description: "Subcycle"
      ROOT_DIS_SEV_CD_PNWRS:
        type: "integer"
        nullable: true
        description: "Root disease severity code PNWRS"
      NF_SUBP_STATUS_CD:
        type: "integer"
        nullable: true
        description: "National forest subplot status code"
      NF_SUBP_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "National forest subplot non-sample reason code"
      P2VEG_SUBP_STATUS_CD:
        type: "integer"
        nullable: true
        description: "P2 vegetation subplot status code"
      P2VEG_SUBP_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "P2 vegetation subplot non-sample reason code"
      INVASIVE_SUBP_STATUS_CD:
        type: "integer"
        nullable: true
        description: "Invasive subplot status code"
      INVASIVE_NONSAMPLE_REASN_CD:
        type: "integer"
        nullable: true
        description: "Invasive non-sample reason code"
      CROWN_CLOSURE_ME_NERS:
        type: "integer"
        nullable: true
        description: "Crown closure Maine NERS"
      GROUND_TRAN_PTS_BARE_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points bare RMRS"
      GROUND_TRAN_PTS_CRYP_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points cryptobiotic RMRS"
      GROUND_TRAN_PTS_DEV_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points developed RMRS"
      GROUND_TRAN_PTS_LICHEN_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points lichen RMRS"
      GROUND_TRAN_PTS_LITTER_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points litter RMRS"
      GROUND_TRAN_PTS_MOSS_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points moss RMRS"
      GROUND_TRAN_PTS_NOTSAMP_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points not sampled RMRS"
      GROUND_TRAN_PTS_OTHER_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points other RMRS"
      GROUND_TRAN_PTS_PEIS_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points PEIS RMRS"
      GROUND_TRAN_PTS_ROAD_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points road RMRS"
      GROUND_TRAN_PTS_ROCK_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points rock RMRS"
      GROUND_TRAN_PTS_TRIS_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points TRIS RMRS"
      GROUND_TRAN_PTS_VEG_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points vegetation RMRS"
      GROUND_TRAN_PTS_WATER_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points water RMRS"
      GROUND_TRAN_PTS_WOOD_RMRS:
        type: "integer"
        nullable: true
        description: "Ground transect points wood RMRS"
      PREV_STATUSCD_RMRS:
        type: "integer"
        nullable: true
        description: "Previous status code RMRS"
      ROOTSEVCD_RMRS:
        type: "integer"
        nullable: true
        description: "Root severity code RMRS"

  # TREE table schema moved to separate file: tree_table_schema.yaml

  BOUNDARY:
    description: "Plot boundary information"
    columns:
      CN:
        type: "varchar(34)"
        nullable: false
        description: "Control number (stored as string for large values)"
      PLT_CN:
        type: "varchar(34)"
        nullable: false
        description: "Plot control number (stored as string for large values)"
      STATECD:
        type: "smallint"
        nullable: false
      CONTRCD:
        type: "tinyint"
        nullable: true
      CONTRAST:
        type: "decimal(4,1)"
        nullable: true

# Schema metadata
metadata:
  notes:
    - "VARCHAR columns with mixed datetime and string values are intentionally kept as strings"  
    - "CREATED_DATE and MODIFIED_DATE columns contain mixed formats and non-date values"
    - "All CN (Control Number) fields use VARCHAR(34) to handle large numeric values"
    - "Decimal precision chosen based on FIA documentation and observed data ranges"
    - "FIA uses 999 as a standard placeholder code for 'not applicable' or missing data"
    - "Integer types sized to accommodate both normal ranges and placeholder codes (999, 9999, etc.)"
    - "PLOT_STATUS_CD can legitimately be null in certain plot conditions"
    - "INVYR ranges from 1930s (historical data) to 2040s (future planned inventories)"
    - "Many classification codes use SMALLINT instead of TINYINT for safety (real data can exceed 127)"
    - "Conservative data type sizing prevents overflow errors during conversion"
  
  problematic_columns:
    - column: "CREATED_DATE"
      issue: "Contains both datetime strings and single character values like 'Y'"
      solution: "Store as VARCHAR to preserve all values"
    - column: "MODIFIED_DATE" 
      issue: "Contains both datetime strings and other mixed values"
      solution: "Store as VARCHAR to preserve all values"
    - column: "CN"
      issue: "Contains very large numeric values that exceed BIGINT capacity"
      solution: "Store as VARCHAR(34) to preserve all values"